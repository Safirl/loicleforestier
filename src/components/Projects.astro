---
import { Image } from 'astro:assets';
import projects from "../data/projects";
import externalLinkArrow from "../assets/arrow.svg"
---
<div class="container">
    <div class="projects">
        <div class="projectFilter">
            <button id="filterDev">Dev</button>
            <button id="filterFilms">Films</button>
        </div>
        <ul class="projectsList">
            {
                projects.map((project) => (
                    <li
                        class="projectItem"
                        data-category={project.category}
                        data-key={project.id}
                    >
                        <a class="primaryLink" target="_blank" rel="noopener noreferrer" href={project.link} data-has-secondary-link={project.secondaryLink == "" ? "false" : "true"}>
                            {project.title}
                            <Image class="externalArrow" src={externalLinkArrow} alt="external link icon" />
                        </a>
                        {project.secondaryLink != "" && (
                            <a
                                class="secondaryLink"
                                href={project.secondaryLink}
                                target="_blank" 
                                rel="noopener noreferrer"
                            >
                                {project.secondaryLinkName}
                            </a>
                        )}
                    </li>
                ))
            }
            <div class="centerOffset"></div>
        </ul>
    </div>
    <div class="projectImage">
        <img id="image" class="projectImage dynamicImage" src={projects[0].image} alt="" />
        <img class="backgroundImage dynamicImage" src={projects[0].image} alt="" />
        <p class="projectDescription">
            {projects[0].description}
        </p>
    </div>
</div>
<!-- Mouse follower -->
<div id="mouseFollower"></div>
<div id="trail"></div>

<style lang="scss">
    @use "../styles/_variables";

    body {
        overflow: hidden;
    }

    .container {
        display: flex;
        justify-content: center;
        gap: 10vw;
        width: 100%;
    }

    .projects {
        display: flex;
        flex-direction: column;
        gap: variables.$spacing-l;
        width: 330px;
    }

    .projectFilter {
        display: flex;
        gap: variables.$spacing-s;

        button {
            transition: ease-in-out opacity .2s;

            &.hidden {
                opacity: 50%;
            }
        }
    }

    .externalArrow {
        width: 30px;
        padding-left: variables.$spacing-s;
    }

    .projectsList {
        display: flex;
        flex-direction: column;
        gap: variables.$spacing-m;
        max-height: calc(100vh - variables.$spacing-l*2 - 10vh - 35px);
        overflow-y: auto;
        // overflow-x: visible;
        scrollbar-width: none;
        scroll-behavior: smooth;

        .centerOffset {
            padding-bottom: 42vh;
        }

    }

    .projectItem {
        display: flex;
        flex-direction: column;
        transition: ease-in-out opacity .2s;
        position: relative;
        // white-space: nowrap;

        &.hidden {
            opacity: 50%;
            pointer-events: none;
            cursor: none;
        }

        &:hover {
            .primaryLink[data-has-secondary-link="true"] {
                margin-bottom: .5rem
            }

            .secondaryLink {
                margin-top: 0%;
                opacity: 100%;
            }
        }
    }

    .primaryLink {
        display: flex;
        font-size: variables.$font-size-l;
        width: fit-content;
        transition: margin-bottom ease-in-out .5s;
        margin-bottom: 0px;

        // &.visible {
        //     margin-bottom: .5rem
        // }
    }

    .secondaryLink {
        font-size: variables.$font-size-s;
        opacity: 0%;
        transition: opacity 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        width: fit-content;
        margin-top: -20px;

        // &.visible {
        //     margin-top: 0%;
        //     opacity: 100%;
        // }
    }

    .projectImage {
        display: flex;
        flex-direction: column;
        gap: variables.$spacing-m;
        position: relative;
        width: 60vh;
        max-width: 600px;
        object-fit: cover;

        .backgroundImage {
            position: absolute;
            z-index: -1;
            top: 50%;
            left: 50%;
            width: 150%;
            transform: translate(-50%, -50%);
            filter: blur(120px);
        }
    }

    //Mouse trail
    #mouseFollower {
        position: absolute;
        width: 100px;
        height: 100px;
        pointer-events: none;
        background-color: red;
        transform: translate(-50%, -50%);
        // transition: all .05s ease-out;
        z-index: -1;
        filter: blur(50px);
        opacity: 50%;
    }

    #trail {
        position: absolute;
    }
</style>

<script>
    import projects from "../data/projects";
    import ColorThief from 'colorthief';
    import {followMouse} from '../js/mouseBlurEffect'

    interface project {
        id: number;
        title: string;
        description: string;
        image: string;
        category: string;
        link: string;
        secondaryLink: string|undefined;
        secondaryLinkName: string|undefined;
    }
    
    const img = new Image();
    img.src = projects[0].image;
    let isDevFilterActive = false;
    let isMovieFilterActive = false;
    let currentProject: project|undefined;

    const filterDev = document.getElementById("filterDev");
    const filterMovie = document.getElementById("filterFilms");
    const projectItems = document.querySelectorAll(".projectItem") as NodeListOf<HTMLLIElement>;
    
    addUpdateProjectImageEvent()
    addFilterEvents()
    
    function addUpdateProjectImageEvent() {
        projectItems.forEach((item) => {
            item.addEventListener("pointerenter", () => {
                currentProject = projects.find((project) => project.id.toString() === item.dataset.key)
                if (!currentProject) {
                    return;   
                }
                img.src = currentProject.image;
                const projectImages = document.querySelectorAll(".dynamicImage") as NodeListOf<HTMLImageElement>;
                projectImages.forEach((img) => {
                    (img as HTMLImageElement).src = (currentProject as project).image;
                })
                const projectDescription = document.querySelector(".projectDescription") as HTMLParagraphElement;
                projectDescription.innerHTML = currentProject.description;
            })
        })
    }

    function addFilterEvents() {
        if (!filterDev || !filterMovie) {
            return;
        }
        //Filter for web projects
        filterDev.addEventListener("click", () => {
            isDevFilterActive = !isDevFilterActive
            if (isDevFilterActive) {
                isMovieFilterActive = !isDevFilterActive
            }
            updateActiveItems()
        });

        //Filter for movie projects
        filterMovie.addEventListener("click", () => {
            isMovieFilterActive = !isMovieFilterActive
            if (isMovieFilterActive) {
                isDevFilterActive = !isMovieFilterActive
            }
            updateActiveItems()
        });
    }

    //Update filter css
    function updateActiveItems() {
        projectItems.forEach((item) => {
            if (item.dataset.category === "dev") {
                if (isMovieFilterActive) {
                    filterDev?.classList.add("hidden")
                    item.classList.add("hidden")
                } else {
                    filterDev?.classList.remove("hidden")
                    item.classList.remove("hidden")
                } 
            } else if (item.dataset.category === "movie") {
                if (isDevFilterActive) {
                    filterMovie?.classList.add("hidden")
                    item.classList.add("hidden")
                } else {
                    filterMovie?.classList.remove("hidden")
                    item.classList.remove("hidden")
                }
            }
        });
    }
    // const projectsContainer = document.querySelector('.projectsList');
    // if (projectsContainer) {
    //     //Scroll on the whole page
    //     document.addEventListener("wheel", (event) => {
    //         projectsContainer.scrollTop += event.deltaY;
    //     });
    // }

    //Change background color with image dominent color
    img.addEventListener('load', () => {
        const colorThief = new ColorThief();
        const dominantColor = colorThief.getColor(img);
        const darkenFactor = .1
        const rgbColor = `rgb(${dominantColor[0]*darkenFactor}, ${dominantColor[1]*darkenFactor}, ${dominantColor[2]*darkenFactor})`
        document.body.style.backgroundColor = rgbColor;
    });

    //MouseFollower
    followMouse(img);
    

</script>
